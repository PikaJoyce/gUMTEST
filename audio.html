<html>
  <script>
    window.mak = { audio: [] };
    function getStreamAndTrack(frequency = 100) {
      console.log('1. Construct AudioContext');
      window.tempAudioContext = window.tempAudioContext || typeof AudioContext !== 'undefined' ? new AudioContext() : new webkitAudioContext()
      const audioContext = window.tempAudioContext;

      if (!audioContext) {
        console.error('audioContext is null');
      }
      console.log('2. Create OscillatorNode')
      const oscillatorNode = audioContext.createOscillator()

      oscillatorNode.type = 'square';
      oscillatorNode.frequency.setValueAtTime(frequency, audioContext.currentTime); // value in hertz

      console.log('3. Create MediaStreamDestinationNode')
      const mediaStreamDestinationNode = audioContext.createMediaStreamDestination()

      console.log('4. Connect OscillatorNode to MediaStreamDestinationNode')
      oscillatorNode.connect(mediaStreamDestinationNode)

      console.log('5. Start OscillatorNode')
      oscillatorNode.start()

      console.log('6. Add MediaStreamDestinationNode\'s MediaStreamTrack to new MediaStream')
      const track = mediaStreamDestinationNode.stream.getAudioTracks()[0]
      console.log('Track Id: ', track.id);
      return track;
    }

    async function playAudioElement(track, removeTrack) {
      const stream = new MediaStream();
      stream.addTrack(track);

      var newDiv = document.createElement("div");
      const audio = document.createElement('audio');
      window.mak.audio.push(audio);
      audio.autoplay = true
      audio.controls = true
      audio.srcObject = stream
      newDiv.appendChild(audio);
      document.body.appendChild(newDiv)

      console.log('8. Wait')
      await new Promise(resolve => setTimeout(resolve, 5000))

      console.log('9. Remove remote MediaStreamTrack from new MediaStream')
      if (removeTrack) {
        stream.removeTrack(track)
      }
      audio.srcObject = null;

      console.log('10. Remove <audio> element')

      audio.remove()

      console.log('Check to see if the audio is still playing...')
    }


    // setup a webrtc session, and passes track to another PC.
    async function routeTrack(track) {
      const stream = new MediaStream();
      stream.addTrack(track);

      console.log('2. Construct 2 RTCPeerConnections')
      const pc1 = new RTCPeerConnection()
      const pc2 = new RTCPeerConnection();

      [[pc1, pc2], [pc2, pc1]].forEach(([pc1, pc2]) => {
        pc1.onicecandidate = event => {
          if (event.candidate) {
            pc2.addIceCandidate(event.candidate)
          }
        }
      })

      console.log(' Add MediaStreamTrack to RTCPeerConnection 1')
      pc1.addTrack ? pc1.addTrack(track, stream) : pc1.addStream(stream);

      console.log(' Negotiate')
      const offer = await pc1.createOffer()
      await Promise.all([
        pc1.setLocalDescription(offer),
        pc2.setRemoteDescription(offer)
      ])
      const answer = await pc2.createAnswer()
      await Promise.all([
        pc1.setRemoteDescription(answer),
        pc2.setLocalDescription(answer)
      ])

      console.log('Get remote MediaStreamTrack from RTCPeerConnection 2')
      let track2
      if (pc2.getRemoteStreams) {
        console.log('getRemoteStreams')
        track2 = pc2.getRemoteStreams()[0].getAudioTracks()[0];
      } else {
        console.log('getReceivers')
        track2 = pc2.getReceivers()[0].track
      }

      return track2;
    }

    async function testWithWebrtc(removeTrack) {
      const frequency = removeTrack ? 1 : 0.5;
      const track1 = getStreamAndTrack(frequency);
      track2 = await routeTrack(track1);
      await playAudioElement(track2, removeTrack);
    }

    async function test(removeTrack) {
      const frequency = removeTrack ? 1 : 1000;
      const track = getStreamAndTrack(frequency);
      console.log('7. Set new MediaStream as srcObject on <audio> element')
      await playAudioElement(track, removeTrack);
    }


    window.onload = function () {
      console.log('onload');
      document.getElementById('testwebrtc1').onclick = testWithWebrtc.bind(null, false)
      document.getElementById('testwebrtc2').onclick = testWithWebrtc.bind(null, true)

      document.getElementById('test1').onclick = test.bind(null, false)
      document.getElementById('test2').onclick = test.bind(null, true)
    }

  </script>
<body>
    <p>
        webrtc Works:
        <button id="testwebrtc1">Test without removeTrack</button>
    </p
    ><p>
        webrtc Doesn't Work:
        <button id="testwebrtc2">Test with removeTrack</button>
    </p>
    <p>
        Normal Works:
        <button id="test1">Test without removeTrack</button>
    </p
    ><p>
        Normal Doesn't Work:
        <button id="test2">Test with removeTrack</button>
    </p>
</body>
</html>
