<html>
  <script>
    function generateAudioTrack(frequency = 1) {
      console.log('1. Construct AudioContext')
      const audioContext = typeof AudioContext !== 'undefined'
        ? new AudioContext()
        : new webkitAudioContext()

      console.log('2. Create OscillatorNode')
      const oscillatorNode = audioContext.createOscillator()

      oscillatorNode.type = 'square';
      oscillatorNode.frequency.setValueAtTime(frequency, audioContext.currentTime); // value in hertz

      console.log('3. Create MediaStreamDestinationNode')
      const mediaStreamDestinationNode = audioContext.createMediaStreamDestination()

      console.log('4. Connect OscillatorNode to MediaStreamDestinationNode')
      oscillatorNode.connect(mediaStreamDestinationNode)

      console.log('5. Start OscillatorNode')
      oscillatorNode.start()

      console.log('6. Add MediaStreamDestinationNode\'s MediaStreamTrack to new MediaStream')
      const track = mediaStreamDestinationNode.stream.getAudioTracks()[0]
      console.log('Track Id: ', track.id);
      return track;
    }

    function createAudioElement() {
      const audio = document.createElement('audio');
      audio.autoplay = true
      audio.controls = true
      console.log('Created an Audio Element')
      return audio;
    }


    // setup a webrtc session, and passes track to another PC.
    async function routeTrack(track) {
      const stream = new MediaStream();
      stream.addTrack(track);
      const pc1 = new RTCPeerConnection()
      const pc2 = new RTCPeerConnection();
      [[pc1, pc2], [pc2, pc1]].forEach(([pc1, pc2]) => {
        pc1.onicecandidate = event => {
          if (event.candidate) {
            pc2.addIceCandidate(event.candidate)
          }
        }
      })

      console.log(' Add MediaStreamTrack to RTCPeerConnection 1')
      pc1.addTrack ? pc1.addTrack(track, stream) : pc1.addStream(stream);

      console.log(' Negotiate')
      const offer = await pc1.createOffer()
      await Promise.all([
        pc1.setLocalDescription(offer),
        pc2.setRemoteDescription(offer)
      ])
      const answer = await pc2.createAnswer()
      await Promise.all([
        pc1.setRemoteDescription(answer),
        pc2.setLocalDescription(answer)
      ])

      console.log('Get remote MediaStreamTrack from RTCPeerConnection 2')
      let track2
      if (pc2.getRemoteStreams) {
        console.log('getRemoteStreams')
        track2 = pc2.getRemoteStreams()[0].getAudioTracks()[0];
      } else {
        console.log('getReceivers')
        track2 = pc2.getReceivers()[0].track
      }

      return track2;
    }

    let webRTCTrack = null;
    let audioElement = null;
    let mediaStream = null;
    async function setup() {
      // create an audio track routed thru webrtc media connection.
      webRTCTrack = await routeTrack(generateAudioTrack());

      mediaStream = new MediaStream();

      audioElement = createAudioElement();
    }


    window.onload = function () {
      console.log('onload');
      document.getElementById('setup').onclick = setup;
      document.getElementById('addTrack').onclick = () => mediaStream.addTrack(webRTCTrack);
      document.getElementById('removeTrack').onclick = () => mediaStream.removeTrack(webRTCTrack);
      document.getElementById('setAudioElementSrcObject').onclick =  () => audioElement.srcObject = mediaStream;
      document.getElementById('resetAudioElementSrcObject').onclick = () => audioElement.srcObject = null;
      document.getElementById('addAudioToDOM').onclick = () => document.body.appendChild(audioElement);
      document.getElementById('removeAudioFromDOM').onclick = () => audioElement.remove();
    }
  </script>
<body>
    <p>
        Step 1) Setup: sets up webrtc mediaStream, audioElement.
        <br>
        <button id="setup">setup</button>
    </p>
    <p>
        Step 2) Add Audo Element to DOM (optional!)
        <br>
        <button id="addAudioToDOM">document.body.appendChild(audioElement);</button>
    </p>
    <p>
        Step 3) AudioElement.srcObject = mediaStream;
        <br>
        <button id="setAudioElementSrcObject">AudioElement.srcObject = mediaStream;</button>
    </p>
    <p>
        Step 4) mediaStream.addTrack(webRTCTrack);
        <br>
        <button id="addTrack">mediaStream.addTrack(webRTCTrack)</button>
    </p>


    <p>
        Unto Step 2:
        <button id="removeAudioFromDOM">audioElement.remove();</button>
    </p>
    <p>
        Unto Step 3:
        <button id="resetAudioElementSrcObject">AudioElement.srcObject = null;</button>
    </p>
    <p>
        Unto Step 4:
        <button id="removeTrack">mediaStream.removeTrack(webRTCTrack)</button>
    </p>
</body>
</html>
